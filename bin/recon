#!/usr/bin/env ruby
require 'edurange'

## NOTE -- THIS IS A TEMPLATE. IT WILL BE DELETED. These are an approximation of what gets generated by the parser for mocking purposes

# Create scenario
scenario = Scenario.new
scenario.game_type = :host_discovery # Any predefined ones, determines method of scoring.
scenario.name = "EDURange"
scenario.save!

# Define roles
web_server_role = Role.new
web_server_role.packages << 'apache2'
web_server_role.save!

dns_server_role = Role.new
dns_server_role.packages << 'bind9'
dns_server_role.save!

attacker_role = Role.new
attacker_role.packages << 'nmap'
attacker_role.packages << 'wireshark'
attacker_role.save!

# Create cloud for our scenario
cloud = Cloud.new
cloud.cidr_block = '10.0.0.0/16'
cloud.scenario = scenario
cloud.save!

# Create subnet for the NAT
nat_subnet = cloud.subnets.new 
nat_subnet.cidr_block = '10.0.128.0/24' # above 10.0.0.0/17
nat_subnet.internet_accessible = true
nat_subnet.save!

# Create NAT instance
nat_instance = nat_subnet.instances.new
nat_instance.allow_traffic '10.0.0.0/24', ingress: {tcp: :ssh} #, egress: {all: :all}
nat_instance.os = :nat
nat_instance.internet_accessible = true
nat_instance.ip_address = '10.0.128.5'
nat_instance.save!


# Create battlespace subnet
battlespace_subnet = cloud.subnets.new
battlespace_subnet.cidr_block = '10.0.0.0/17' # 10.0.0.0 - 10.0.127.255
battlespace_subnet.save!

# Create battlespace instances
(0..10).each do |i|
  instance = battlespace_subnet.instances.new
  instance.ip_address = "10.0.0.#{i + 5}"
  instance.os = :ubuntu
  instance.roles << web_server_role
  instance.allow_traffic '10.0.0.0/24', ingress: {all: :all}
  instance.save!
end

# Create player subnet
players_subnet = cloud.subnets.new
players_subnet.cidr_block = '10.0.129.0/24'
players_subnet.save!

# Create player instances
(1..5).each do |team_num|
  instance = players_subnet.instances.new
  instance.ip_address = "10.0.129.#{team_num + 5}"
  instance.os = :ubuntu
  instance.roles << attacker_role
  instance.save!

  group = Group.new
  group.name = "team_#{team_num}"
  group.save!

  instance.add_administrator group
  nat_instance.add_user group
  (1..3).map {|i| (3 * team_num) + i}.each do |player_num|
    player = group.players.new
    player.login = "edurange_#{player_num}"
    player.password = "ffff"
    player.save!
  end
end

scenario.boot
Edurange.wait_for_jobs
